<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="author" content="Pel" />
	<meta name="copyright" content="2011(c)webpluz.org" />
	<title>Audio Player from WebPlus</title>
	<style type="text/css">
		#container{ width:250px; border:1px solid #000; font:12px/150% Simsun,Arial; padding:5px; }
		#title{ float:left; width:150px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
		#time{ float:right; }
		#range{ display:block; margin:0; padding:0; width:250px; clear:both; }
		.button{ display:inline-block; border:1px solid #000; text-align:center; padding:3px; text-decoration:none; color:#000; }
		.button:hover{ border-color:#966; color:#966; }
		#play{ width:40px; }
		#volume{ width:75px; vertical-align:bottom; }
		#playlist{ border:1px solid #000; margin:5px 0 0; padding:0; list-style-position:inside; }
		#playlist li{ margin:0; padding:1px 5px; cursor:pointer; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
		#playlist li:hover{ color:#966; }
		#playlist li.selected{ background:#eee; color:#966; }
	</style>
</head>
<body>
	<div id="container">
		<div id="title">Empty</div>
		<div id="time">--:-- / --:--</div>
		<input id="range" type="range" min="0" max="1" step="any" value="0" />
		<!--<a id="prev" class="button" href="###">上一首</a>-->
		<a id="play" class="button" href="###"></a>
		<!--<a id="next" class="button" href="###">下一首</a>-->
		音量:<input id="volume" type="range" min="0" max="1" step="0.1" value="0.5" />
		<!--<ol id="playlist">
		</ol>-->
	</div>
	<script type="text/javascript" src="http://pub.idqqimg.com/lib/jx/1.0.2/jx.uiless.min.js"></script>
	<script type="text/javascript" src="jx.audio.js"></script>
	<script type="text/javascript" src="jx.ui.range.js"></script>
<script type="text/javascript">
if(!window.console){
	window.console = {
		info : function(){},
		log : function(){}
	};
}
Jx().$package(function(J){
	var list = J.dom.mini('input[type=range]');
	if(list && list[0] && list[0].type !== 'range'){
		for(var i=0,len=list.length; i<len; i++){
			J.ui.range.build(list[i]);
		}
	}
});
Jx().$package(function(J){
	var audioObj,
		titleEl,
		timeEl,
		rangeEl,
		playEl,
		volumeEl,
		paused;
	function initAudio(){
		var _audio;
		if(audioObj){ return; } //如果存在,说明已经初始化
		if(Jx().Audio){
			_audio=new (Jx().Audio)();

		var audio = _audio;
		/*audio.on('abort',function(){console.log(Date.now(),'abort')});
		audio.on('canplay',function(){console.log(Date.now(),'canplay')});
		audio.on('canplaythrough',function(){console.log(Date.now(),'canplaythrough')});
		audio.on('durationchange',function(){console.log(Date.now(),'durationchange')});
		audio.on('emptied',function(){console.log(Date.now(),'emptied')});
		audio.on('ended',function(){console.log(Date.now(),'ended')});
		audio.on('error',function(){console.log(Date.now(),'error')});
		audio.on('loadeddata',function(){console.log(Date.now(),'loadeddata')});
		// audio.on('loadedmetadata',function(){console.log(Date.now(),'loadedmetadata')});
		audio.on('loadstart',function(){console.log(Date.now(),'loadstart')});
		audio.on('pause',function(){console.log(Date.now(),'pause')});
		audio.on('play',function(){console.log(Date.now(),'play')});
		audio.on('playing',function(){console.log(Date.now(),'playing')});
		audio.on('progress',function(){console.log(Date.now(),'progress')});
		audio.on('ratechange',function(){console.log(Date.now(),'ratechange')});
		audio.on('seeked',function(){console.log(Date.now(),'seeked')});
		audio.on('seeking',function(){console.log(Date.now(),'seeking')});
		audio.on('stalled',function(){console.log(Date.now(),'stalled')});
		// audio.on('suspend',function(){console.log(Date.now(),'suspend')});
		audio.on('timeupdate',function(){console.log(Date.now(),'timeupdate')});
		audio.on('volumechange',function(){console.log(Date.now(),'volumechange')});
		audio.on('waiting',function(){console.log(Date.now(),'waiting')});*/


			_audio.on('durationchange',onDurationChange);
			_audio.on('play',onPlay);
			_audio.on('pause',onPause);
			_audio.on('ended',onEnded);
			_audio.on('error',onError);
			_audio.on('timeupdate',onTimeUpdate);
			_audio.setVolume(0.5);
			
			audioObj=_audio;
			titleEl=document.getElementById('title');
			timeEl=document.getElementById('time');
			rangeEl=document.getElementById('range');
			playEl=document.getElementById('play');
			volumeEl=document.getElementById('volume');
			
			J.event.on(volumeEl,'change',onVolumeChange);
			J.event.on(rangeEl,'change',onRangeChange);
			J.event.on(playEl,'click',onPlayButtonClick);
		}else{
			alert('Oops, nice browser.');
			return;
		}
	}
	function loadAudio(url,title){
		if(!audioObj){ return; }
		var name=title || url.replace(/^.*\//,'').replace(/[#\?].*$/,'') || 'Unknown';
		titleEl.innerHTML=name;
		rangeEl.value=0;
		// rangeEl.disabled=true;
		timeEl.innerHTML='--:-- / --:--';
		playEl.innerHTML='加载中';
		// audioObj.autoplay=true;
		audioObj.play(url);
		//audioObj.load();
		paused = false;
	}

	function onDurationChange(){
		console.info('canplay');
		rs=undefined;
		rangeEl.disabled=false;
	}
	function onPlay(){
		playEl.innerHTML='暂停';
		console.info('play');
		rs=undefined;
	}
	function onPause(){
		playEl.innerHTML='播放';
	}
	function onEnded(){
		// audioObj.pause();
		// audioObj.currentTime=0;
		paused = true;
		playEl.innerHTML='播放';
	}
	function onError(e){
		console.info(JSON.stringify(e))
		rangeEl.disabled=true;
		titleEl.innerHTML='<span style="color:red">加载错误:'+titleEl.innerHTML+'</span>';
		playEl.innerHTML='已停止';
	}
	function onTimeUpdate(){
		var pos=audioObj.getPosition(),
			dora=audioObj.getDuration();
		timeEl.innerHTML=formatTime(pos)+' / '+formatTime(dora);
		//console.info(pos,dora);
		if(isFinite(dora) && dora>0){
			rangeEl.value=pos/dora;
		}
	}
	function onVolumeChange(){
		if(!audioObj){ return; }
		audioObj.setVolume(volumeEl.value);
	}
	function onRangeChange(){
		if(!audioObj){ return; }
		var buf=audioObj.getBuffered(),
			dora=audioObj.getDuration();
		if(isFinite(dora) && dora>0){
			var value=rangeEl.value,
				pos=value*dora;
			if(pos>buf){
				pos=buf;
			}
			audioObj.setPosition(pos);
		}
	}
	function onPlayButtonClick(){
		if(!audioObj){ return; }
		if(paused){
			audioObj.play();
		}else{
			audioObj.pause();
		}
		paused = !paused;
	}
	function formatTime(sec){
		if(!isFinite(sec) || sec<0){
			return '--:--';
		}else{
			var m=Math.floor(sec/60),
				s=Math.floor(sec)%60;
			return (m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
		}
	}
	initAudio();
	loadAudio('wdgsl.mp3','msg');
	// loadAudio('','xx');
});
</script>
</body>
</html>